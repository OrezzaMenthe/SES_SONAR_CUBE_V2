ifneq ($(AUTH), y)
AUTHN_NONE=n
AUTHN_BASIC=n
AUTHN_DIGEST=n
AUTHZ_SIMPLE=n
AUTHZ_FILE=n
AUTHZ_UNIX=n
AUTHZ_SQLITE=n
endif

ifneq ($(DOCUMENT), y)
SENDFILE=n
DOCUMENTREST=n
DIRLISTING=n
RANGEREQUEST=n
DOCUMENTHOME=n
endif

TARGET=ouistiti
sbin-y+=$(TARGET)
ifeq ($(VTHREAD_TYPE),pthread)
$(TARGET)_LIBRARY-$(VTHREAD)+=pthread rt
endif
$(TARGET)_SOURCES+=main.c
$(TARGET)_LIBS+=httpserver

ifneq ($(wildcard $(LIBHTTPSERVER_DIR)/src/httpserver/libhttpserver.so),)
$(TARGET)_LDFLAGS+=-L$(LIBHTTPSERVER_DIR)/src/httpserver
$(TARGET)_LDFLAGS+=-L$(LIBHTTPSERVER_DIR)/src
endif
ifneq ($(wildcard $(LIBHTTPSERVER_DIR)/lib/libhttpserver.so),)
$(TARGET)_LDFLAGS+=-L$(LIBHTTPSERVER_DIR)/lib
endif
ifneq ($(wildcard $(LIBHTTPSERVER_DIR)/libhttpserver.so),)
$(TARGET)_LDFLAGS+=-L$(LIBHTTPSERVER_DIR)
endif

ifneq ($(wildcard $(LIBHTTPSERVER_DIR)/include/httpserver/httpserver.h),)
$(TARGET)_CFLAGS+=-I$(LIBHTTPSERVER_DIR)/include
endif
ifneq ($(wildcard $(LIBHTTPSERVER_DIR)/httpserver/httpserver.h),)
$(TARGET)_CFLAGS+=-I$(LIBHTTPSERVER_DIR)
endif

$(TARGET)_CFLAGS-$(FILE_CONFIG)+=-DFILE_CONFIG
$(TARGET)_SOURCES-$(FILE_CONFIG)+=config.c
$(TARGET)_LIBRARY-$(FILE_CONFIG)+=config
$(TARGET)_LIBRARY-$(MBEDTLS)+=mbedtls mbedx509 mbedcrypto
$(TARGET)_LIBRARY-$(WOLFSSL)+=wolfssl
$(TARGET)_LIBRARY-$(OPENSSL)+=ssl crypto

$(TARGET)_CFLAGS-$(MODULES)+=-DMODULES
$(TARGET)_LIBS-$(MODULES)+=dl

$(TARGET)_CFLAGS-$(WEBSOCKET_RT)+=-DWEBSOCKET_RT
$(TARGET)_SOURCES-$(WEBSOCKET_RT)+=websocket.c
$(TARGET)_SOURCES-$(WEBSTREAM)+=websocket.c

ifneq ($(MAX_SERVERS),)
$(TARGET)_CFLAGS+=-DMAXSERVERS=$(MAX_SERVERS)
endif

ifneq ($(MODULES),y)
$(TARGET)_LIBS-$(MBEDTLS)+=mod_mbedtls
$(TARGET)_LIBS-$(WOLFSSL)+=mod_wolfssl
$(TARGET)_LIBS-$(DOCUMENT)+=mod_document
$(TARGET)_LIBS-$(CGI)+=mod_cgi
$(TARGET)_LIBS-$(AUTH)+=mod_auth
$(TARGET)_LIBS-$(VHOSTS)+=mod_vhosts
$(TARGET)_LIBS-$(METHODLOCK)+=mod_methodlock
$(TARGET)_LIBS-$(WEBSOCKET)+=mod_websocket
$(TARGET)_LIBS-$(SERVERHEADER)+=mod_server
$(TARGET)_LIBS-$(CLIENTFILTER)+=mod_clientfilter
$(TARGET)_LIBS-$(REDIRECT404)+=mod_redirect404
$(TARGET)_LIBS-$(WEBSTREAM)+=mod_webstream
$(TARGET)_LIBS-$(COOKIE)+=mod_cookie
endif
$(TARGET)_LIBS-$(WEBSOCKET)+=websocket
$(TARGET)_LIBS-$(WEBSOCKET)+=hash_mod
$(TARGET)_LIBS-$(DOCUMENT)+=utils_mod
$(TARGET)_LIBS-$(CGI)+=utils_mod
$(TARGET)_LIBS-$(AUTH)+=hash_mod

$(TARGET)_LIBRARY-$(MBEDTLS)+=mbedtls mbedx509 mbedcrypto
$(TARGET)_LIBRARY-$(WOLFSSL)+=wolfssl
$(TARGET)_LIBRARY-$(AUTHZ_SQLITE)+=sqlite3
$(TARGET)_LIBRARY-$(AUTHZ_UNIX)+=crypt

$(TARGET)_CFLAGS-$(MBEDTLS)+=-DTLS
$(TARGET)_CFLAGS-$(WOLFSSL)+=-DTLS
$(TARGET)_CFLAGS-$(DOCUMENT)+=-DDOCUMENT
$(TARGET)_CFLAGS-$(SENDFILE)+=-DSENDFILE
$(TARGET)_CFLAGS-$(DIRLISTING)+=-DDIRLISTING
$(TARGET)_CFLAGS-$(RANGEREQUEST)+=-DRANGEREQUEST
$(TARGET)_CFLAGS-$(DOCUMENTREST)+=-DDOCUMENTREST
$(TARGET)_CFLAGS-$(DOCUMENTHOME)+=-DDOCUMENTHOME
$(TARGET)_CFLAGS-$(CGI)+=-DCGI
$(TARGET)_CFLAGS-$(AUTH)+=-DAUTH
$(TARGET)_CFLAGS-$(AUTHN_NONE)+=-DAUTHN_NONE
$(TARGET)_CFLAGS-$(AUTHN_BASIC)+=-DAUTHN_BASIC
$(TARGET)_CFLAGS-$(AUTHN_DIGEST)+=-DAUTHN_DIGEST
$(TARGET)_CFLAGS-$(AUTHZ_SIMPLE)+=-DAUTHZ_SIMPLE
$(TARGET)_CFLAGS-$(AUTHZ_FILE)+=-DAUTHZ_FILE
$(TARGET)_CFLAGS-$(AUTHZ_UNIX)+=-DAUTHZ_UNIX
$(TARGET)_CFLAGS-$(AUTHZ_SQLITE)+=-DAUTHZ_SQLITE
$(TARGET)_CFLAGS-$(VHOSTS)+=-DVHOSTS
$(TARGET)_CFLAGS-$(METHODLOCK)+=-DMETHODLOCK
$(TARGET)_CFLAGS-$(WEBSOCKET)+=-DWEBSOCKET
$(TARGET)_CFLAGS-$(SERVERHEADER)+=-DSERVERHEADER
$(TARGET)_CFLAGS-$(CLIENTFILTER)+=-DCLIENTFILTER
$(TARGET)_CFLAGS-$(REDIRECT404)+=-DREDIRECT404
$(TARGET)_CFLAGS-$(WEBSTREAM)+=-DWEBSTREAM
$(TARGET)_CFLAGS-$(COOKIE)+=-DCOOKIE

$(TARGET)_CFLAGS-$(DEBUG)+=-g -DDEBUG
$(TARGET)_LIBRARY-$(DEBUG)+=rt

subdir-$(CGI)+=mod_cgi.mk
subdir-$(DOCUMENT)+=mod_document.mk
subdir-$(AUTH)+=mod_auth.mk
subdir-$(VHOSTS)+=mod_vhosts.mk
subdir-$(METHODLOCK)+=mod_methodlock.mk
subdir-$(SERVERHEADER)+=mod_server.mk
subdir-$(CLIENTFILTER)+=mod_clientfilter.mk
subdir-$(REDIRECT404)+=mod_redirect404.mk
subdir-$(WEBSTREAM)+=mod_webstream.mk
