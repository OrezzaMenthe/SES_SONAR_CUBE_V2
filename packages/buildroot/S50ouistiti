#!/bin/sh
#
# Starts ouistiti.
#

SYSCONFDIR=/etc/ouistiti
RUNDIR=/var/run
SBINDIR=/usr/sbin
BINDIR=/usr/bin
SERVER=ouistiti
ORGANISATION=ouistiti
COUNTRY=fr

init() {
	if [ ! -f ${SYSCONFDIR}/ouistiti_srv.key -a -x ${BINDIR}/gen_key ]; then
		${BINDIR}/gen_key type=rsa rsa_keysize=4096 filename=${SYSCONFDIR}/ouistiti_srv.key
	fi
	if [ ! -f  ${SYSCONFDIR}/ouistiti_srv.crt -a -x ${BINDIR}/cert_write ]; then
		AFTER=$(date +%Y%m%d%H%M%S)
		BEFORE=$(( ${AFTER} + 10000000000 ))
		${BINDIR}/cert_write selfsign=1 issuer_key=${SYSCONFDIR}/ouistiti_srv.key \
			issuer_name=CN=${SERVER},O=${ORGANISATION},C=${COUNTRY} \
			not_before=${AFTER} not_after=${BEFORE} \
			is_ca=1 max_pathlen=0 output_file=${SYSCONFDIR}/ouistiti_srv.crt
	fi
	if [ ! -f ${SYSCONFDIR}/ouistiti_srv.csr ]; then
		#CSR file useless for self-certificated website
		#send this file to SSL vendor to receive a Certificate (ouistiti_srv.crt)
		${BINDIR}/cert_req filename=${SYSCONFDIR}/ouistiti_srv.key \
			subject_name=CN=${SERVER},O=${ORGANISATION},C=${COUNTRY} \
			output_file=${SYSCONFDIR}/ouistiti_srv.csr
	fi
	if [ ! -f ${SYSCONFDIR}/ouistiti_dhparam.key ]; then
		cd ${SYSCONFDIR}
		${BINDIR}/dh_genprime
		mv dh_prime.txt ouistiti_dhparam.key
	fi
}

start() {
	printf "Starting ouistiti: "
#	start-stop-daemon -S -q -p ${RUNDIR}/ouistiti.pid --exec ${SBINDIR}/ouistiti -- -D -f ${SYSCONFDIR}/ouistiti.conf
	${SBINDIR}/ouistiti -D -p ${RUNDIR}/ouistiti.pid -f ${SYSCONFDIR}/ouistiti.conf
	echo "OK"
	mkdir ${RUNDIR}/websocket
	chmod a+rw ${RUNDIR}/websocket
	nohup /usr/bin/websocket_chat -R ${RUNDIR}/websocket -u www-data -w &
}
stop() {
	printf "Stopping ouistiti: "
#	start-stop-daemon -K -q -p ${RUNDIR}/ouistiti.pid
	kill $(cat ${RUNDIR}/ouistiti.pid)
	echo "OK"
}
restart() {
	stop
	start
}

case "$1" in
  start)
	init
	start
	;;
  stop)
	stop
	;;
  restart|reload)
	restart
	;;
  *)
	echo "Usage: $0 {start|stop|restart}"
	exit 1
esac

exit $?

